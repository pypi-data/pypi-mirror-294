# Generated by Django 1.11.20 on 2019-04-05 09:20
from django.db import (
    migrations,
)


def set_num_libsummarybook(apps, schema_editor):
    """Заполняет №№ записи КСУ для поступлений."""
    LibSummaryBook = apps.get_model('lib_registry', 'LibSummaryBook')
    lib_summary_book = LibSummaryBook.objects.all().order_by(
        'school_id',
        'record_date',
        'id',
    )

    num = 0
    school_id = None
    for rec in lib_summary_book:
        if rec.school_id == school_id:
            num += 1
        else:
            num = 1
            school_id = rec.school_id
        rec.inflow_record_number = num
        rec.save()


class Migration(migrations.Migration):

    dependencies = [
        ('lib_registry', '0018_libsummarybook_inflow_record_number'),
    ]

    operations = [
        # Миграция считается пройденной в ЭШ и не должна выполняться на чистой БД.
        #
        # migrations.RunPython(
        #     set_num_libsummarybook,
        #     reverse_code=migrations.RunPython.noop
        # ),
    ]
