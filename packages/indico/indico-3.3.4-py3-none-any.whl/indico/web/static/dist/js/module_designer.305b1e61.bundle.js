(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[3517],{46645:(e,t,i)=>{"use strict";var a=i(13830),n=i.n(a),o=i(87493),l=i.n(o),s=i(20469),d=i.n(s),r=i(74095),c=i.n(r),h=i(58466),g=i.n(h),u=i(61988),p=i.n(u),f=i(46755),m=i.n(f),b=i(25584);!function(e){var t,i,a,o,s,r=!1,h=-1,u=!1,f={},v={},x=null,k={},w=null,_=null,j=!1,y=b.$T.gettext("The back side of the templates that use this one as the back side will be removed."),T=b.$T.gettext("Disassociate back sides"),C=!1;let z=null,I=null,M=null;function D(e){return z.includes(e)}function F(e){return e*s}function O(e){return e/s}function q(e,t){return e(/([0-9.]+)pt/g.exec(t)[1])+"pt"}var H=m()(q,F),P=m()(q,F);function W(e){var t={id:++h,type:e,x:a,y:o,font_family:"sans-serif",bold:!1,italic:!1,text_align:"center",color:"#000000",background_color:null,font_size:"15pt",width:D(e)?150:400,height:D(e)?150:null,text:(0,b.$T)("Fixed text"),zIndex:h+10,selected:!1};return t.toHTML=function(){return $("<div>").addClass("designer-item").toggleClass("selected",this.selected).css({width:F(this.width),height:this.height?F(this.height):this.height,cursor:"move",fontWeight:this.bold?"bold":"normal",fontStyle:this.italic?"italic":"normal",fontFamily:this.font_family,fontSize:H(this.font_size),textAlign:this.text_align.replace("Justified","justify"),color:this.color,backgroundColor:this.background_color,zIndex:this.zIndex}).attr("data-type",this.type).text("fixed"===this.type?this.text:"fixed_image"===this.type&&this.image_id?"":k[this.type])}.bind(t),t}function E(e,t){this.realWidth=e,this.realHeight=t,this.width=F(e),this.height=F(t)}function L(e,t){var i=t?".template-side.back":".template-side.front",a=$("<div/>").css({position:"absolute",left:e.x+"px",top:e.y+"px",zIndex:e.zIndex}).data("id",e.id).attr("data-id",e.id).appendTo(i);return t||a.draggable({containment:i,opacity:.5,drag:function(e,t){r&&(t.position.left=10*Math.floor(t.position.left/10),t.position.top=10*Math.floor(t.position.top/10))},stop:function(e,t){var i=$(this).data("id");f[i].x=O(t.position.left),f[i].y=O(t.position.top)}}),a}function A(e,t){if(e.length){var i=e.closest(".ui-draggable").data("id");return t?v[i]:f[i]}}function S(){return A($(".designer-item.selected"))}function U(e){var t=A(e);t&&(t.selected=!1,e.removeClass("selected"))}function J(e){var t=A(e);$(".element-tools").removeClass("hidden"),$(".second-row").removeClass("disappear"),$(".selection-text").html(k[t.type]),"fixed_image"===t.type&&$(".js-remove-img").prop("disabled",!t.image_id);const i=$("#imageFile");$(".js-upload-img").prop("disabled",!i.val()),U($(".designer-item.selected")),t.selected=!0,e.addClass("selected");var n=g()([t.bold?"bold":null,t.italic?"italic":null]);$("#text-color-selector").val(t.color);const o=$("#text-color-preview");o.toggleClass("no-value",!t.color),o.css({backgroundColor:t.color}),$("#bg-color-selector").val(t.background_color);const l=$("#bg-color-preview");l.toggleClass("no-value",!t.background_color),l.css({backgroundColor:t.background_color}),$("#alignment-selector").val(t.text_align),$("#font-selector").val(t.font_family),$("#size-selector").val(t.font_size),$("#style-selector").val(n.length?n.join("_"):"normal"),$(".js-element-width").val(t.width/a),$(".js-element-height").val(t.height/a);var s=$("#fixed-text-field");const d=$("#subtool-element-height");var r=$(".font-tools"),c=$("#fixed-image-tool");"fixed"===t.type?(r.show(),s.closest(".tool").show(),s.val(t.text),d.hide(),c.hide()):D(t.type)?(r.hide(),s.closest(".tool").hide(),d.show(),c.hide(),"fixed_image"===t.type&&c.show()):(r.show(),s.closest(".tool").hide(),s.val(""),d.hide(),c.hide())}function N(){var e,n=Math.ceil(i.width/a),o=Math.ceil(t.width/a),l=Math.ceil(i.height/a),s=Math.ceil(t.height/a);if(t.width>i.width){var d=$("#horizontal-ruler");for(e=n;e<o;e++)$('<div class="marking"/>').attr("id","rulerh"+e).css({width:a+"px",left:e*a+"px",top:0}).html(e+1).appendTo(d)}else if(t.width<i.width)for(e=n;e>o;e--)$("#rulerh"+(e-1)).remove();if(t.height>i.height){var r=$("#vertical-ruler");for(e=l;e<s;e++)$('<div class="marking"/>').attr("id","rulerv"+e).css({"line-height":a/2+"px",height:a+"px",left:0,top:e*a+"px"}).html(e+1).appendTo(r)}else if(t.height<i.height)for(e=l;e>s;e--)$("#rulerv"+(e-1)).remove()}function B(e,n){var o=$(".template-container"),l=parseFloat($(".template-width").val()),s=parseFloat($(".template-height").val());o.width(Math.round(l*a)),o.height(Math.round(s*a)),i.width=t.width,i.height=t.height,t=new E(Math.round(50*l),Math.round(50*s)),N(),function(e,t){V(e),t.background_url&&V(t,!0)}(e,n),function(e,t){$(".js-preset-tool option").each((function(){var i=$(this);if("custom"!==i.val()){var a=i.data("width"),n=i.data("height");a===e&&n===t&&(i.prop("selected",!0),$(".js-template-dimension").prop("disabled",!0))}}))}(l,s)}function G(e,t){const{x:i,y:a}=e,{x:n,y:o}=t,l=i+e.width,s=a+(e.height||22),d=n+t.width,r=o+(t.height||22);return!(i>=d||n>=l)&&!(a>=r||o>=s)}function K(){l()(Object.values(f),"zIndex").forEach(((e,t)=>{e.zIndex=t+10,$(".ui-draggable[data-id="+e.id+"]").css("zIndex",t+10)}))}function Q(e){var t=S(),i=$(".designer-item.selected");i&&({font:function(){t.font_family=$("#font-selector").val()},color:function(){t.color=$("#text-color-selector").val(),/^[a-f0-9]{3,6}$/.test(t.color)&&(t.color=`#${t.color}`,$("#text-color-selector").val(t.color))},background_color:function(){t.background_color=$("#bg-color-selector").val(),/^[a-f0-9]{3,6}$/.test(t.background_color)&&(t.background_color=`#${t.background_color}`,$("#bg-color-selector").val(t.background_color))},alignment:function(){t.text_align=$("#alignment-selector").val()},size:function(){t.font_size=$("#size-selector").val()},style:function(){switch($("#style-selector").val()){case"normal":t.bold=!1,t.italic=!1;break;case"bold":t.bold=!0,t.italic=!1;break;case"italic":t.bold=!1,t.italic=!0;break;case"bold_italic":t.bold=!0,t.italic=!0}},text:function(){var e=$("#fixed-text-field");t.text=e.val().replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),e.val(t.text)},width:function(){t.width=Math.round($(".js-element-width").val()*a),"ticket_qr_code"===t.type&&($(".js-element-height").val($(".js-element-width").val()),t.height=t.width)},height:function(){t.height=Math.round($(".js-element-height").val()*a),"ticket_qr_code"===t.type&&($(".js-element-width").val($(".js-element-height").val()),t.width=t.height)}}[e](),i.replaceWith(t.toHTML()),"fixed_image"===t.type&&$(".designer-item.selected").append(X(t)))}function R(e,i){if("stretch"===i)e.css({left:0,top:0}),e.height(t.height),e.width(t.width);else if("center"===i){var a,n=(o=e,(l=new Image).src=o.attr("src"),{width:l.width,height:l.height});e.height(n.height),e.width(n.width),e.width()>t.width||e.height()>t.height?(e.width()>t.width&&(a=t.width/e.width(),e.width(t.width),e.height(e.height()*a),e.css({left:0,top:t.height/2-e.height()/2+"px"})),e.height()>t.height&&(a=t.height/e.height(),e.width(e.width()*a),e.height(t.height),e.css({left:t.width/2-e.width()/2+"px",top:0}))):e.css({left:t.width/2-n.width/2+"px",top:t.height/2-n.height/2+"px"})}var o,l}function V(e,i){var a=i?".template-side.back":".template-side.front",n=$(a).find(".background-image"),o=e.data.background_position;n.attr({src:e.background_url}).css({position:"absolute",left:0,top:0,height:t.height+"px",width:t.width+"px",zIndex:5}).on("load",(function(){$("#loadingIcon").hide(),R($(this),o)})).appendTo(a)}function X(e){const t=$("<img/>");return t.attr({src:I[e.image_id]}).css({position:"absolute",left:0,top:0,height:e.height+"px",width:e.width+"px"}),t}function Y(e,t){e.data&&(e.data.items.forEach((function(e){!function(e,t){delete e.id;var i=p()(W(),e);t?v[i.id]=i:f[i.id]=i}(e,t)})),function(e){var t=e?v:f;$.each(t,(function(t,i){var a=L(i,e);a.css({left:F(i.x)+"px",top:F(i.y)+"px",zIndex:i.zIndex}),a.append(i.toHTML()),"fixed_image"===i.type&&i.image_id&&X(i).appendTo(a.find(".designer-item")),i.selected&&!e&&J(a.find(".designer-item"))}))}(t)),ee(!(t&&e.data&&(e.data.items.length||e.background_url))),e.background_url&&V(e,t)}function Z(e){var t=$(".template-side.back");e.background_url&&(e.background_url=null,t.find(".background-image").remove(),t.append($("<img>",{class:"background-image"}))),t.find(".designer-item").remove(),e.title=null,e.data=null,v={}}function ee(e){var t=$(".backside-placeholder");t.parent().toggleClass("empty",e),t.toggle(e),$(".backside-tools").toggleClass("hidden",e)}function te(e){ee(e),$(".backside-tools").toggleClass("hidden",!e),e?($(".backside-placeholder").addClass("to-be-removed"),$(".placeholder-text").html(b.$T.gettext("This back side template will be removed")),$(".placeholder-link").hide(),y=b.$T.gettext("The back side of this template will be removed"),T=b.$T.gettext("Disassociate back side"),C=!0):($(".backside-placeholder").removeClass("to-be-removed"),$(".placeholder-text").html(b.$T.gettext("The back side is empty.")),$(".placeholder-link").show(),y=b.$T.gettext("The back side of the templates that use this one as the back side will be removed."),T=b.$T.gettext("Disassociate back sides"),C=!1)}function ie(e,t,i,a){if($("#backside-warning").length||null!==x){var n=null;$("#backside-warning").length&&null!==x?n=$(".affected-targets-warning"):$("#backside-warning").length?n=$("#backside-warning"):null!==x&&(n=$("#frontside-warning")),50*e.val()!==i?(null!==x&&te(!0),n.show("fast"),j=!0):50*t.val()===a&&(n.hide("fast"),null!==x&&te(!1),j=!1)}}function ae(){$("#frontside-warning").hide("fast"),te(!1),C=!1,j=!1}e.setupDesigner=function(e,l,h,g,p){u=!!e,k=Object.assign(...Object.values(g).map((({options:e})=>e))),s=h.zoom_factor,a=F(50),o=a,x=l.id,z=p,I={...e.images,...l.images},$(document).ready((function(){var i=$(".js-remove-bg").qtip();$('#bg-form input[type="file"]').on("change",(function(){var e=$(this);this.files&&e.next("label").removeClass("i-button").text(this.files[0].name),$(".js-upload-bg").prop("disabled",!e.val()).toggleClass("highlight",!!e.val())})),$('#img-form input[type="file"]').on("change",(function(){var e=$(this);this.files&&e.next("label").removeClass("i-button").text(this.files[0].name),$(".js-upload-img").prop("disabled",!e.val()).toggleClass("highlight",!!e.val())})),$(".template-content").on("mousedown",".designer-item",(function(){J($(this))})).on("dblclick",".designer-item",(function(){!function(e){var t=A(e);if("fixed"===t.type){var i=prompt("Enter fixed-text value",t.text);if(i){var a=e.parent(".ui-draggable");t.text=i,a.html(t.toHTML())}}}($(this))})),$(".js-upload-bg").click((function(){return $(".js-toggle-side.front").click(),$("#bg-form").submit(),!1})),$(".js-upload-img").click((function(){return M=S(),"fixed_image"===M.type&&$("#img-form").submit(),!1})),$("#grid-snap").change((function(){r=this.checked})).change(),$("#bg-form").ajaxForm({dataType:"json",iframe:!1,success:function(t){t.error?alertPopup(t.error,(0,b.$T)("Error")):(e.background_url=t.image_url,V(e),$(".template-side.front").trigger("indico:backgroundChanged"))}}),$("#img-form").ajaxForm({dataType:"json",iframe:!1,success:function(e){e.error?alertPopup(e.error,(0,b.$T)("Error")):"fixed_image"===M.type&&(M.image_id=e.image_id,I[e.image_id]=e.image_url,function(){const e=$(".ui-draggable[data-id="+M.id+"] div");e.text(""),e.find("img").remove(),X(M).appendTo(e);const t=$("#imageFile");t.val(""),t.next("label").addClass("i-button").text(b.$T.gettext("Choose a file")),$(".js-upload-img").prop("disabled",t.val()),$(".js-remove-img").prop("disabled",!M.image_id)}())}}),$("input[name=bg-position]").change((function(t){t.preventDefault();var i=$(this).val();R($(".template-side.front .background-image"),i),e.data.background_position=i})),$(".js-remove-bg").click((function(t){t.preventDefault(),i.qtip("api").toggle(),function(e){e.background_url&&(e.background_url=null,$(".template-side.front").trigger("indico:backgroundChanged"))}(e)})),$(".js-remove-img").click((function(e){e.preventDefault();const t=S();var i;"fixed_image"===t.type&&(i=t).image_id&&(i.image_id=null,$(".ui-draggable[data-id="+i.id+"] div").text(b.$T.gettext("Fixed Image")),$(".ui-draggable[data-id="+i.id+"] img").remove(),$(".js-remove-img").prop("disabled",!i.image_id))})),$(".move-button").click((function(e){e.preventDefault(),function(e){var i=S(),a=$(".designer-item.selected").parent();({left:function(){a&&(a.css("left",0),i.x=0)},right:function(){if(a){var e=t.width-a.width();a.css("left",e>0?e+"px":0),i.x=O(e>0?e:0)}},center:function(){if(a){var e=(t.width-a.width())/2,n=(t.height-a.height())/2;a.css("left",e>0?e+"px":0),a.css("top",n>0?n+"px":0),i.x=O(e>0?e:0),i.y=O(n>0?n:0)}},top:function(){a&&(a.css("top",0),i.y=0)},bottom:function(){if(a){var e=t.height-a.height();a.css("top",e>0?e+"px":0),i.y=O(e>0?e:0)}},back:function(){if(a){const e=c()(Object.values(f).filter((e=>i.id!==e.id&&G(i,e))),"zIndex"),t=Math.min(i.zIndex,e.zIndex-1);i.zIndex=t,K()}},front:function(){if(a){const e=d()(Object.values(f).filter((e=>i.id!==e.id&&G(i,e))),"zIndex"),t=Math.max(i.zIndex,e.zIndex+1);i.zIndex=t,K()}}})[e]()}($(this).data("direction"))})),$(".js-font-tool").change((function(){Q($(this).data("attr"))})),$(".insert-element-btn").click((function(e){var i,n,l;e.preventDefault(),$(".js-toggle-side.front").click(),i=W($("#element-list").val()),n=L(i),l=i.toHTML().appendTo(n),f[i.id]=i,J(l),o+=a,o%=t.height-20})),$(".js-remove-element").click((function(e){var t,i;e.preventDefault(),t=$(".designer-item.selected"),(i=S())&&(delete f[i.id],t.remove(),$(".element-tools").addClass("hidden"))})),$(".js-save-template").click((function(i){i.preventDefault(),function(e){if(""!==$(".js-template-name").val())if(Object.keys(f).length||e.background_url)if(Object.values(f).some((e=>"fixed_image"===e.type&&!e.image_id)))alertPopup(b.$T.gettext("The Fixed image element cannot be empty. Upload an image inside it or remove it."),b.$T.gettext("Warning"));else{C&&(x=null);var i={template:{width:t.realWidth,height:t.realHeight,background_position:$("input[name=bg-position]:checked").val(),items:n()(f).map((function(e){return $.extend(!0,{},e).font_size=P(e.font_size),e}))},clear_background:!e.background_url,title:$(".js-template-name").val(),is_clonable:$('input[name="is-clonable"]:checked').length>0,backside_template_id:x};(j?confirmPrompt(b.$T.gettext("Are you sure you want to change the dimensions of this template?")+y,T):$.Deferred().resolve()).then((function(){$.ajax({url:location.pathname,data:JSON.stringify(i),contentType:"application/json",method:"POST",complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(e){w=t.width,_=t.height,C&&($(".affected-targets-warning").hide("fast"),te(!1),$(".js-remove-backside").click(),C=!1,j=!1),handleFlashes(e,!0)}})}))}else alertPopup(b.$T.gettext("The template cannot be empty. Add some elements or a background image."),b.$T.gettext("Warning"));else alertPopup(b.$T.gettext("Please choose a name for the template"),(0,b.$T)("Warning"))}(e)})),$(".template-width, .template-height").on("input",(function(){B(e,l)})),$(".js-element-width").on("keyup click",(function(){Q("width")})),$(".js-element-height").on("keyup click",(function(){Q("height")})),$("#fixed-text-field").on("keyup",(function(){Q("text")})),$(".js-preset-tool").on("change",(function(){var t=$(this).find("option:selected");"custom"!==t.val()&&($(".template-width").val(t.data("width")).change(),$(".template-height").val(t.data("height")).change(),B(e,l)),$(".js-template-dimension").prop("disabled","custom"!==t.val())})),$(".js-toggle-side").on("click",(function(){var e=$(this),t=e.hasClass("front")?"front":"back",i=$(".designer-item.selected"),a=l.data&&(l.data.items.length||l.background_url);$(".template-content").toggleClass("flipped","back"===t),$(".template-side.back").toggleClass("active","back"===t),$(".template-side.front").toggleClass("active","front"===t),$(".backside-tools").toggleClass("hidden","front"===t||!a),$(".js-toggle-side").removeClass("highlight"),$(".element-tools").addClass("hidden"),$(".js-hide-on-flip").toggle("back"!==t),$(".js-invisible-on-flip").toggleClass("disappear","back"===t),e.toggleClass("highlight"),i&&i[0]&&U(i),$(".template-side.active").trigger("indico:backgroundChanged")})),$(".template-side").on("indico:backgroundChanged",(function(){var t=$("#backgroundFile"),i=$(".template-side.front"),a=i.find(".background-image");!e.background_url&&a.attr("src")&&(a.remove(),i.append($("<img>",{class:"background"})),t.val(""),t.next("label").addClass("i-button").text(b.$T.gettext("Choose a file"))),$(".js-upload-bg").prop("disabled",!t.val()),$(".js-remove-bg").prop("disabled",!e.background_url),$("#bg-position-stretch").prop("checked","stretch"===e.data.background_position),$("#bg-position-center").prop("checked","center"===e.data.background_position)})),$(".template-side.front").trigger("indico:backgroundChanged"),$(".template-side.back").on("indico:backsideUpdated",(function(e,t){x=t.backside_template_id,Object.assign(I,t.template.images),Z(l),Y(t.template,!0),l=t.template,C&&ae(),$(".backside-template-title, .js-front-affected-title").text(t.template.title)})),$(".js-remove-backside").on("click",(function(){x=null,Z(l),C&&ae(),ee(!0)})),$(".js-change-orientation").on("click",(function(){var t=$(".template-width"),i=$(".template-height"),a=t.val();t.val(i.val()).change(),i.val(a).change(),B(e,l)})),$(".js-backside-list-dialog").on("click",(function(){var e=$(this);ajaxDialog({trigger:e,url:e.data("href"),data:{width:t.realWidth,height:t.realHeight},title:e.data("title")})})),$(".backside-tools").addClass("hidden");var s=$(".template-width"),h=$(".template-height");s.on("change input",(function(){ie($(this),h,w,_)})),h.on("change input",(function(){ie($(this),s,_,w)})),$(".js-back-affected").qbubble({overwrite:!0,position:{target:$(".js-back-affected")},content:{text:$(".back-warning-qtip-content").html()},hide:{event:"unfocus click"},show:{event:"click"}}),$(".js-front-affected").qbubble({overwrite:!0,position:{target:$(".js-front-affected")},content:{text:function(){return $(".front-warning-qtip-content").html()}},hide:{event:"unfocus click"},show:{event:"click"}})})),u?(t=new E(e.data.width,e.data.height),$(".js-template-name").val(e.title),$(".js-is-clonable").prop("checked",e.is_clonable),$(".template-container").width(t.width).height(t.height)):t=new E(h.tpl_size[0],h.tpl_size[1]),i=new E(0,0),$(".template-width").val(t.width/a),$(".template-height").val(t.height/a),w=t.width,_=t.height,N(),B(e,l),Y(e),Y(l,!0)}}(window)},74268:(e,t,i)=>{var a=i(14183);e.exports=function(e,t){var i=[];return a(e,(function(e,a,n){t(e,a,n)&&i.push(e)})),i}},4214:e=>{e.exports=function(e,t){return e<t}},77610:(e,t,i)=>{var a=i(26837),n=i(17921),o=i(53435),l=n((function(e,t){a(t,o(t),e)}));e.exports=l},61988:(e,t,i)=>{e.exports=i(77610)},58466:(e,t,i)=>{var a=i(40836),n=i(74268),o=i(94207),l=i(64383);e.exports=function(e,t){return(l(e)?a:n)(e,o(t,3))}},74095:(e,t,i)=>{var a=i(74321),n=i(94207),o=i(4214);e.exports=function(e,t){return e&&e.length?a(e,n(t,2),o):void 0}}},e=>{e.O(0,[2076],(()=>{return t=46645,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=module_designer.305b1e61.bundle.js.map