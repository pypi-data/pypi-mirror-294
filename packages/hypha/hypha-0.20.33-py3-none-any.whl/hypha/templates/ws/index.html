<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypha Workspace Management</title>
    <!-- External Scripts -->
    <script src="../assets/hypha-rpc-websocket.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="https://rawcdn.githack.com/nextapps-de/winbox/0.2.82/dist/winbox.bundle.min.js"></script>
    <!-- Favicon and Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./static/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./static/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./static/img/favicon-16x16.png">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.3.0/github-markdown-light.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap">
    <!-- Meta Tags -->
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <style>
        /* Styles for the sidebar and main content */
        .sidebar {
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #1f2937;
            padding-top: 20px;
            transition: all 0.3s;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar .logo {
            text-align: center;
            margin-bottom: 1rem;
        }

        .sidebar .menu-item {
            padding: 1rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .sidebar .menu-item:hover {
            background-color: #374151;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .main-content {
            padding: 20px;
            transition: all 0.3s;
        }

        .main-content.collapsed {
            margin-left: 60px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .main-content {
                margin-left: 60px;
            }

            .sidebar .menu-item span {
                display: none;
            }
        }

        .service-card {
            background-color: #2d3748;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1f2937;
            border-radius: 0.5rem;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-body {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-black text-white font-poppins">
    <div id="app"></div>
    <script type="module">
        import { HyphaCore } from "https://cdn.jsdelivr.net/npm/hypha-core@0.20.33/dist/hypha-core.mjs";

        const defaultService = {
            getServerConfig(context){
                let token;
                try{
                    token = document.cookie.split('; ').find(row => row.startsWith('access_token')).split('=')[1]
                }
                catch(e){
                    token = null;
                }
                return {
                    server_url: window.location.origin,
                    workspace: decodeURIComponent(window.location.href.split(window.location.origin)[1].split('/')[1]),
                    token,
                }
            }
        }
        const hyphaCore = new HyphaCore({base_url: "/hypha-core-app/", default_service: defaultService});
        hyphaCore.on("add_window", (config) => {
            const root = document.getElementById("hypha-window-container");
            // get the left and top position of the root element
            // then set it to the WinBox
            const rect = root.getBoundingClientRect();

            const wb = new WinBox(config.name || config.src.slice(0, 128), {
                root: root,
                y: rect.top + 10,
                x: rect.left + 10,
                background: "#448aff",
            });
            wb.body.innerHTML = `<iframe src="${config.src}" id="${config.window_id}" style="width: 100%; height: 100%; border: none;"></iframe>`;
        });
        const api = await hyphaCore.start();

        console.log("Hypha core started:", hyphaCore.url);
        async function loadPluginFromUrl(url) {
            const plugin = await api.loadPlugin({ src: url});
            await plugin.run({ config: {}, data: {} });
            console.log("Loaded and ran plugin from URL:", url);
        }
        window.loadPlugin = loadPluginFromUrl;

        window.loadCodeEditor = async function () {
            const response = await fetch("/ws/code_template.html");
            const pythonPluginCode = await response.text();
            const codeEditor = await api.loadPlugin({
                src: "https://if.imjoy.io",
            });
            await codeEditor.run({ config: {fold: [1]},  data: {code: pythonPluginCode} });
            console.log("Loaded and ran code editor plugin");
        };
    </script>

    <!-- Render the App component -->
    <script type="text/babel" data-presets="env,react" data-env-targets="defaults, safari >= 12">
        const Sidebar = ({ isCollapsed, onToggle, setActivePanel }) => {
            return (
                <div className={`sidebar ${isCollapsed ? 'collapsed' : ''}`}>
                    <div className="logo">
                        <img src="./static/img/hypha-logo-black.svg" className={`h-10 invert ${isCollapsed ? 'hidden' : 'block'}`} alt="Hypha Logo" />
                    </div>
                    <div className="menu-item" onClick={() => onToggle()}>
                        <i className="fas fa-bars"></i>
                        <span className="ml-2">Menu</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('dashboard')}>
                        <i className="fas fa-users"></i>
                        <span className="ml-2">Dashboard</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('services')}>
                        <i className="fas fa-cogs"></i>
                        <span className="ml-2">Services</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('apps')}>
                        <i className="fas fa-th-large"></i>
                        <span className="ml-2">Apps</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('files')}>
                        <i className="fas fa-folder"></i>
                        <span className="ml-2">Files</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('development')}>
                        <i className="fas fa-code"></i>
                        <span className="ml-2">Development</span>
                    </div>
                    <div className="menu-item" onClick={() => setActivePanel('tokens')}>
                        <i className="fas fa-key"></i>
                        <span className="ml-2">Connection Tokens</span>
                    </div>

                </div>
            );
        };

        const ClientCard = ({ client }) => {
            return (
                <div className="flex flex-col items-center p-6 bg-gray-800 rounded-lg shadow-lg mb-6">
                    <i className="fas fa-user fa-3x text-white mb-4"></i>
                    <div className="text-center">
                        <h3 className="text-xl font-bold">{client.split("/")[1]}</h3>
                    </div>
                </div>
            );
        };

        const ServiceCard = ({ service, onShowDetails }) => {
            return (
                <div className="service-card">
                    <i className={`fas fa-cog fa-3x text-white mb-4`}></i>
                    <div className="text-center">
                        <h3 className="text-xl font-bold">{service.id.split(":")[1]}</h3>
                        <button
                            className="mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                            onClick={() => onShowDetails(service)}
                        >
                            View Details
                        </button>
                    </div>
                </div>
            );
        };

        const AppCard = ({ app }) => {
            return (
                <div className="flex flex-col items-center p-6 bg-gray-800 rounded-lg shadow-lg mb-6">
                    <i className={`fas fa-th-large fa-3x text-white mb-4`}></i>
                    <div className="text-center">
                        <h3 className="text-xl font-bold">{app.name}</h3>
                        <p className="text-gray-400">{app.description}</p>
                    </div>
                </div>
            );
        };

        const FileCard = ({ file, onGenerateUrl }) => {
            return (
                <div className="flex justify-between items-center p-4 bg-gray-700 rounded-lg shadow-lg mb-4">
                    <div>
                        <i className="fas fa-file-alt mr-2"></i>
                        {file.name}
                    </div>
                    <button
                        className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                        onClick={() => onGenerateUrl(file.name)}
                    >
                        <i className="fas fa-share"></i>
                    </button>
                </div>
            );
        };

        const Modal = ({ serviceInfo, onClose }) => {
            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2 className="text-2xl font-bold">Service Details</h2>
                            <button onClick={onClose} className="text-white text-2xl">&times;</button>
                        </div>
                        <div className="modal-body">
                            <pre className="whitespace-pre-wrap text-gray-200">
                                {JSON.stringify(serviceInfo, null, 2)}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        const TokenPanel = ({ workspaceName, onGenerateToken }) => {
            const [workspace, setWorkspace] = React.useState(workspaceName);
            const [expiryTime, setExpiryTime] = React.useState(3600);
            const [generatedToken, setGeneratedToken] = React.useState('');
            const [showSnackBar, setShowSnackBar] = React.useState(false);

            const handleGenerateToken = async () => {
                try {
                    const token = await onGenerateToken(workspace, expiryTime);
                    setGeneratedToken(token);
                } catch (error) {
                    console.error("Failed to generate token:", error);
                    alert("Failed to generate token. Please try again later.");
                }
            };
        
            const handleCopyToken = () => {
                navigator.clipboard.writeText(generatedToken);
                setShowSnackBar(true);
                setTimeout(() => setShowSnackBar(false), 2000); // Snack bar disappears after 2 seconds
            };
        
            return (
                <div className="main-content">
                    <div className="mt-4">
                        <label htmlFor="workspace" className="block text-sm font-medium text-gray-700">
                            Workspace Name
                        </label>
                        <input
                            type="text"
                            id="workspace"
                            name="workspace"
                            className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                            value={workspace}
                            onChange={(e) => setWorkspace(e.target.value)}
                        />
                    </div>
                    <div className="mt-4">
                        <label htmlFor="expiry-time" className="block text-sm font-medium text-gray-700">
                            Expiry Time (seconds)
                        </label>
                        <input
                            type="number"
                            id="expiry-time"
                            name="expiry-time"
                            className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                            placeholder="3600"
                            value={expiryTime}
                            onChange={(e) => setExpiryTime(e.target.value)}
                        />
                    </div>
                    <div className="mt-4">
                        <button
                            className="bg-blue-500 text-white py-2 px-4 rounded"
                            onClick={handleGenerateToken}
                        >
                            Generate Token
                        </button>
                    </div>
                    {generatedToken && (
                        <div className="mt-4">
                            <h3 className="text-lg font-bold">Generated Token:</h3>
                            <pre className="text-black bg-gray-200 p-4 rounded break-words whitespace-pre-wrap max-h-48 overflow-y-auto">
                                {generatedToken}
                            </pre>
                            <button 
                                className="bg-gray-500 text-white py-1 px-4 rounded mt-2" 
                                onClick={handleCopyToken}
                            >
                                Copy Token
                            </button>
                        </div>
                    )}
                    {showSnackBar && (
                        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded shadow-md">
                            Token copied to clipboard!
                        </div>
                    )}
                </div>
            );
        };
        

        const MainContent = ({ isCollapsed, ws, workspaceName, panel, clients, services, apps, files, onGenerateUrl, onShowDetails, onInstallApp }) => {
            const mainContentClass = isCollapsed ? 'ml-16' : 'ml-64'; // Dynamic left margin
        
            return (
                <div className={`main-content transition-all duration-300 ${mainContentClass}`}>
                    <h1 className="text-4xl font-bold capitalize">{panel}</h1>
        
                    {panel === 'dashboard' && (
                        <>
                            <p className="text-xl text-gray-400 mt-4">
                                Dashboard for workspace: <code>{workspaceName}</code>
                            </p>
                            <div className="grid grid-cols-1 gap-8 mt-6">
                                <h2 className="text-2xl font-bold">Clients</h2>
                                {clients.map(client => (
                                    <ClientCard key={client} client={client} />
                                ))}
                            </div>
                        </>
                    )}
                    {panel === 'services' && (
                        <>
                            <p className="text-xl text-gray-400 mt-4">
                                Services available at workspace: <code>{workspaceName}</code>
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-6">
                                {services.map(service => (
                                    <ServiceCard key={service.id} service={service} onShowDetails={onShowDetails} />
                                ))}
                            </div>
                        </>
                    )}
                    {panel === 'apps' && (
                        <>
                            <p className="text-xl text-gray-400 mt-4">
                                Applications installed in workspace: <code>{workspaceName}</code>
                            </p>
                            <button
                                className="mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                                onClick={() => onInstallApp()}
                            >
                                Install App
                            </button>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-6">
                                {apps.map(app => (
                                    <AppCard key={app.id} app={app} />
                                ))}
                            </div>
                        </>
                    )}
                    {panel === 'files' && (
                        <>
                            <p className="text-xl text-gray-400 mt-4">
                                Files in workspace: <code>{workspaceName}</code>
                            </p>
                            <div className="mt-6">
                                {files.map(file => (
                                    <FileCard key={file.name} file={file} onGenerateUrl={onGenerateUrl} />
                                ))}
                            </div>
                        </>
                    )}
                    {panel === 'development' && (
                        <main className="development-panel">
                            <p className="text-xl text-gray-400 mt-4">Development panel with Hypha server simulation</p>
                            <button
                                onClick={() => window.loadCodeEditor()}
                                className="mt-4 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                            >
                                New App
                            </button>
                            <div
                                style={{ display: 'block', width: '100%', height: '100%', position: 'fixed' }}
                                id="hypha-window-container"
                            ></div>
                        </main>
                    )}
                    {panel === 'tokens' && (
                        <TokenPanel
                            workspaceName={workspaceName}
                            onGenerateToken={async (workspace, expiryTime) => {
                                const token = await ws.generateToken({ expires_in: expiryTime, workspace });
                                return token;
                            }}
                        />
                    )}
                </div>
            );
        };
        
        let token;
        try{
            token = document.cookie.split('; ').find(row => row.startsWith('access_token')).split('=')[1]
        }
        catch(e){
            token = null;
        }
        const config = {
            token,
            server_url: window.location.origin,
            workspace: decodeURIComponent(window.location.href.split(window.location.origin)[1].split('/')[1])
        };

        const App = () => {
            const [isCollapsed, setIsCollapsed] = React.useState(false);
            const [activePanel, setActivePanel] = React.useState('dashboard');
            const [clients, setClients] = React.useState([]);
            const [services, setServices] = React.useState([]);
            const [apps, setApps] = React.useState([]);
            const [files, setFiles] = React.useState([]);
            const [ws, setWs] = React.useState(null);
            const [selectedService, setSelectedService] = React.useState(null);
        
            React.useEffect(() => {
                // Connect to the Hypha server
                const connectToServer = async () => {
                    const remoteServer = await hyphaWebsocketClient.connectToServer(config);
                    window.remoteServer = remoteServer;
                    setWs(remoteServer);
                };
                connectToServer();
            }, []);
        
            React.useEffect(() => {
                // Fetch initial workspace data
                const fetchWorkspaceData = async () => {
                    if (!ws) {
                        return;
                    }
                    if (activePanel === 'dashboard') {
                        setClients(await ws.listClients());
                    } else if (activePanel === 'services') {
                        setServices(await ws.listServices(config.workspace));
                    } else if (activePanel === 'apps') {
                        try {
                            const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                            const apps = await controller.listApps();
                            console.log('Apps:', apps);
                            setApps(apps);
                        } catch (e) {
                            alert(`Failed to list apps: ${e.message}`);
                        }
                    } else if (activePanel === 'files') {
                        try {
                            const s3 = await ws.getService('public/s3-storage', { case_conversion: 'camel' });
                            const files = await s3.listFiles('');
                            console.log('Files:', files);
                            setFiles(files);
                        } catch (e) {
                            alert(`Failed to list files: ${e.message}`);
                        }
                    }
                };
                fetchWorkspaceData();
                document.title = `${activePanel.charAt(0).toUpperCase() + activePanel.slice(1)} - Hypha Workspace Management`;
            }, [activePanel, ws]);
        
            const onGenerateUrl = async (fileName) => {
                const presignedUrl = await ws.generatePresignedUrl(fileName);
                console.log('Presigned URL:', presignedUrl);
            };
        
            const onShowDetails = (service) => {
                setSelectedService(service);
            };
        
            const onInstallApp = async () => {
                const url = prompt(
                    'Enter the URL of the app to install',
                    'https://raw.githubusercontent.com/amun-ai/hypha/main/tests/testWebWorkerPlugin.imjoy.html'
                );
                try {
                    if (!url) return;
                    const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                    const appInfo = await controller.install(url);
                    console.log('App installed:', appInfo);
                    setApps(await controller.listApps());
                } catch (e) {
                    alert(`Failed to install app: ${e.message}`);
                }
            };
        
            const closeModal = () => {
                setSelectedService(null);
            };
        
            return (
                <div>
                    <Sidebar isCollapsed={isCollapsed} onToggle={() => setIsCollapsed(!isCollapsed)} setActivePanel={setActivePanel} />
                    <MainContent
                        isCollapsed={isCollapsed}
                        ws={ws}
                        workspaceName={config.workspace}
                        panel={activePanel}
                        clients={clients}
                        services={services}
                        apps={apps}
                        files={files}
                        onGenerateUrl={onGenerateUrl}
                        onShowDetails={onShowDetails}
                        onInstallApp={onInstallApp}
                    />
                    {selectedService && <Modal serviceInfo={selectedService} onClose={closeModal} />}
                </div>
            );
        };        

        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>

</html>
