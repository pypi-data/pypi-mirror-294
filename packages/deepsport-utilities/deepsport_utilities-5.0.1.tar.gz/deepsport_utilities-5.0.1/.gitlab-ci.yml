image: "python:3.10"

before_script:  # Docker provisionning (required for for every job).
  - apt-get update -qy
  - apt install -y libgl1-mesa-glx
  - pip install uv

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID  # Avoid dublicated jobs on merge commits
      when: never
    - when: always

# stages [build test deploy] # (default)

build_stage:
  stage: build
  script:
    - uv sync --extra dev

test_stage:
  stage: test
  script:
    - uv sync --extra dev
    - uv run pytest

deploy_stage:
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - uv sync --extra dev
    - uvx --from build pyproject-build
    - uvx twine upload dist/*
  dependencies: [build_stage]
  release:                               # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: '$CI_COMMIT_TAG'
    description: '$CI_COMMIT_TAG'
