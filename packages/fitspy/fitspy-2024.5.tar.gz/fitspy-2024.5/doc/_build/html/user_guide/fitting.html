<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting &mdash; Fitspy 2024.5beta documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Workflow" href="workflow.html" />
    <link rel="prev" title="Peak models" href="peak_models.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Fitspy
              <img src="../_static/logo_black.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2024.5beta
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_data.html">Input data files</a></li>
<li class="toctree-l1"><a class="reference internal" href="baseline.html">Baselines and Background models</a></li>
<li class="toctree-l1"><a class="reference internal" href="peak_models.html">Peak models</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#noise-level">Noise level</a></li>
<li class="toctree-l2"><a class="reference internal" href="#outliers">Outliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fitting-parameters">Fitting parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fitting-algorithm">Fitting algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convergence-criterion">Convergence criterion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maximum-number-of-iterations">Maximum number of iterations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#weighting">Weighting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-threading">Multi-threading</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameters-values-initialization">Parameters values initialization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#constraints-settings">Constraints settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#models-parameters-fixing">Models parameters fixing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#models-parameters-bounding">Models parameters bounding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#models-parameters-coupling">Models parameters coupling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflow.html">Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_mode.html">Auto mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui.html">GUI description</a></li>
<li class="toctree-l1"><a class="reference internal" href="outputs.html">Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/release_notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/dev_notes.html">Developers Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">fitspy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Fitspy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Fitting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user_guide/fitting.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fitting">
<h1>Fitting<a class="headerlink" href="#fitting" title="Permalink to this heading"></a></h1>
<p>The fitting processing is performed using the methods provided by the <a class="reference external" href="https://lmfit.github.io//lmfit-py/">lmfit</a> package.</p>
<p>However, to facilitate the convergence of the fitting process, the signal can be pre-processed to subsequently distinguish between noise or outliers and ‘physical’ signal.</p>
<section id="noise-level">
<h2>Noise level<a class="headerlink" href="#noise-level" title="Permalink to this heading"></a></h2>
<p>After <strong>baseline subtraction</strong>, to avoid spending time in fitting peak models amidst noise, models in the ‘noisy regions’ are disabled.</p>
<p>A global noise level associated to each spectrum is first estimated (as the median of the absolute amplitudes of oscillating parts of the spectrum).</p>
<p>All peaks models located in areas below this noise level (multiplied by a user coefficient) are disabled and all the associated parameters (except <code class="code docutils literal notranslate"><span class="pre">x0</span></code>) are set to 0.</p>
</section>
<section id="outliers">
<h2>Outliers<a class="headerlink" href="#outliers" title="Permalink to this heading"></a></h2>
<p>To determine outliers, a certain number of spectra of the same nature are required in order to be able to deduce numerically abnormal amplitude variations. This is well-suited particularly for 2D-map spectra.</p>
<p>First, a ‘normal spectra’ envelop is determined from the values of the 5th maximum intensity of all the spectra at any point (considering a null probability of having more than 5 outliers at the same point).</p>
<p>Outliers are then determined as points exceeding this envelope by a certain coefficient.</p>
<p>In the fit processing, outliers have a null weight associated with them (see below), and at the preceding baseline definition step, linear interpolations of the signal with respect to the points surrounding these outliers are performed.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../_images/outliers.png"><img alt="../_images/outliers.png" src="../_images/outliers.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Illustration for a 2D-map spectra of the ‘normal spectra’ envelop (in red line) with coefficient 1.5, and resulting outliers (in green dots).</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="fitting-parameters">
<h2>Fitting parameters<a class="headerlink" href="#fitting-parameters" title="Permalink to this heading"></a></h2>
<section id="fitting-algorithm">
<h3>Fitting algorithm<a class="headerlink" href="#fitting-algorithm" title="Permalink to this heading"></a></h3>
<p>In the GUI, the pre-selected fitting algorithms  are <code class="code docutils literal notranslate"><span class="pre">Leastsq</span></code>, <code class="code docutils literal notranslate"><span class="pre">Least_squares</span></code>, <code class="code docutils literal notranslate"><span class="pre">Nelder-Mead</span></code>, <code class="code docutils literal notranslate"><span class="pre">SLSQP</span></code> which correspond in <strong>`lmfit`</strong> to the <em>‘leastsq’, ‘least_squares’, ‘nelder’</em> and <em>‘slsqp’</em> fitting algorithms (resp.).</p>
<p>In python script, all the allowed <strong>`lmfit`</strong> fitting algorithms can be used via the <code class="code docutils literal notranslate"><span class="pre">method</span></code> argument passed to <a class="reference internal" href="../api/fitspy.spectrum.html#fitspy.spectrum.Spectrum.fit" title="fitspy.spectrum.Spectrum.fit"><code class="xref py py-func docutils literal notranslate"><span class="pre">fit()</span></code></a>.</p>
</section>
<section id="convergence-criterion">
<h3>Convergence criterion<a class="headerlink" href="#convergence-criterion" title="Permalink to this heading"></a></h3>
<p>The convergence criterion is most often associated with a threshold to be reached on the calculated residual during the minimization procedure (gradient descent). Each fitting method used by <strong>`lmfit`</strong> has its own way of specifying this criterion.
For <code class="code docutils literal notranslate"><span class="pre">Leastsq</span></code> and <code class="code docutils literal notranslate"><span class="pre">Least_squares</span></code> the <code class="code docutils literal notranslate"><span class="pre">xtol</span></code> parameter can be pass to the fit function (see the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.least_squares.html">scipy</a> documentation for more details about this parameter). Otherwise, for the other fitting methods, in scripting mode, tolerance criteria can be passed through the <code class="code docutils literal notranslate"><span class="pre">fit_kws</span></code> in the <code class="code docutils literal notranslate"><span class="pre">kwargs</span></code> arguments of the <a class="reference internal" href="../api/fitspy.spectrum.html#fitspy.spectrum.Spectrum.fit" title="fitspy.spectrum.Spectrum.fit"><code class="xref py py-func docutils literal notranslate"><span class="pre">fit()</span></code></a> function (in a format compatible with the fit method).</p>
<p>This convergence criterion naturally has a significant impact on performance. (Refer to the section <a class="reference external" href="fitting.html#performance">above</a>).</p>
</section>
<section id="maximum-number-of-iterations">
<h3>Maximum number of iterations<a class="headerlink" href="#maximum-number-of-iterations" title="Permalink to this heading"></a></h3>
<p>This number, which corresponds to the maximum number of calls of the gradient descent process, is set by default to 200. It can be beneficial, when fitting numerous spectra, to decrease this value to save computation time, ensuring it does not significantly compromise the quality of the fits. Sometimes, just a few dozen iterations are indeed sufficient.</p>
<p>In the GUI, when the maximum number is reached without meeting the convergence criterion, the fit result is labeled as ‘non-converged’ and is displayed with an orange banner in the files selector widget. In case of convergence, the banner turns green.</p>
</section>
<section id="weighting">
<h3>Weighting<a class="headerlink" href="#weighting" title="Permalink to this heading"></a></h3>
<p>Similarly to noisy areas of outliers, the presence of negative values in the profiles to be fitted, resulting notably from baseline or background removal, can adversely affect the quality of results. To mitigate the impact of these negative values during the fit, a weight of ‘0’ can be assigned to them. This is achieved through the <strong>‘fit negative values : Off’</strong> option in the GUI or by the <code class="code docutils literal notranslate"><span class="pre">fit_negative</span></code> parameter passed to <a class="reference internal" href="../api/fitspy.spectrum.html#fitspy.spectrum.Spectrum.fit" title="fitspy.spectrum.Spectrum.fit"><code class="xref py py-func docutils literal notranslate"><span class="pre">fit()</span></code></a>.</p>
<p>(The same with <code class="code docutils literal notranslate"><span class="pre">fit_outliers</span></code> for outliers and <code class="code docutils literal notranslate"><span class="pre">coef_noise</span></code> to bypass regions defined mainly by noise).</p>
</section>
<section id="multi-threading">
<h3>Multi-threading<a class="headerlink" href="#multi-threading" title="Permalink to this heading"></a></h3>
<p>In the GUI, the default mode is <strong>‘Number of CPU : auto’</strong> which adapts automatically the number of CPU to the number of profiles to be processed and the CPU capability of the machine (by utilizing up to half of the available CPU resources).</p>
</section>
<section id="parameters-values-initialization">
<h3>Parameters values initialization<a class="headerlink" href="#parameters-values-initialization" title="Permalink to this heading"></a></h3>
<p>Also known as the <strong>Guess init</strong> step, the initial values assigned to the models parameters are crucial in the subsequent process of minimizing residuals through gradient descent. When poorly adapted to the profiles to be fitted, they can lead to inappropriate results (local minima), or even prevent the gradient descent. This is why the predefined models in Fitspy have their own methods for evaluating such initial values. The use of <strong>user-defined models</strong> without these methods and where all parameters are initialized to 1, can thus lead to bad convergence.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible that repeated actions of fits on a ‘converged profile’ may lead to small variations.</p>
</div>
</section>
</section>
<section id="constraints-settings">
<h2>Constraints settings<a class="headerlink" href="#constraints-settings" title="Permalink to this heading"></a></h2>
<section id="models-parameters-fixing">
<h3>Models parameters fixing<a class="headerlink" href="#models-parameters-fixing" title="Permalink to this heading"></a></h3>
<p>Each parameters can be set to free (default) or not during the fit processing. Fixing the parameters is achieved in the GUI by activating the boxes located to the right of each parameter.</p>
</section>
<section id="models-parameters-bounding">
<h3>Models parameters bounding<a class="headerlink" href="#models-parameters-bounding" title="Permalink to this heading"></a></h3>
<p>For each parameter, a range can be assigned for the fit processing. For the <code class="code docutils literal notranslate"><span class="pre">peaks</span> <span class="pre">models</span></code> parameters, these ranges are defined at certain default values. In the GUI, these ranges can be adjusted through the <code class="code docutils literal notranslate"><span class="pre">Parameters</span></code> widget by activating the  <code class="code docutils literal notranslate"><span class="pre">show</span> <span class="pre">bounds</span></code> box.</p>
</section>
<section id="models-parameters-coupling">
<h3>Models parameters coupling<a class="headerlink" href="#models-parameters-coupling" title="Permalink to this heading"></a></h3>
<p>Similarly, in the <code class="code docutils literal notranslate"><span class="pre">Parameters</span></code> widget, constraints can be associated with each parameter, by activating the <code class="code docutils literal notranslate"><span class="pre">show</span> <span class="pre">expressions</span></code> box and providing the constraints as explained <a class="reference external" href="gui.html#fitting">here</a>.</p>
</section>
</section>
<section id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this heading"></a></h2>
<p>The performance varies depending on factors such as the number of spectra to handle, the number of points per spectrum, the number of peaks to fit, the <code class="code docutils literal notranslate"><span class="pre">xtol</span></code> convergence criterion,… and, of course, the machine ‘s performance, including its multiprocessing capabilities.</p>
<p>Here is an example of the performance obtained from applying the <cite>Fitspy</cite> <a class="reference external" href="https://github.com/CEA-MetroCarac/fitspy/blob/main/examples/data/2D_maps/model.json">model.json</a> (which includes the baseline removal and fitting 5 peak models per spectrum) to all <strong>1520 spectra</strong> related to the example <a class="reference external" href="https://github.com/CEA-MetroCarac/fitspy/tree/main/examples/ex_gui_users_defined_models_2d_map.py">ex_gui_users_defined_models_2d_map.py</a>.</p>
<table class="docutils align-center" id="id2">
<caption><span class="caption-text">Performance</span><a class="headerlink" href="#id2" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 59%" />
<col style="width: 6%" />
<col style="width: 6%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Machine</p></th>
<th class="head"><p>Number of processors</p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">xtol</span></code></p></th>
<th class="head"><p>CPU time (s)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PC Windows</p></td>
<td><p>8 (Intel(R) Core(TM) i5-10400H CPU &#64; 2.60GHz)</p></td>
<td><p>0.01</p></td>
<td><p>175</p></td>
</tr>
<tr class="row-odd"><td><p>Windows server</p></td>
<td><p>36 (Intel(R) Xeon(R) Gold 6154 CPU &#64; 3.00GHz)</p></td>
<td><p>0.01</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>Windows server</p></td>
<td><p>36 (Intel(R) Xeon(R) Gold 6154 CPU &#64; 3.00GHz)</p></td>
<td><p>0.001</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>Windows server</p></td>
<td><p>36 (Intel(R) Xeon(R) Gold 6154 CPU &#64; 3.00GHz)</p></td>
<td><p>0.0001</p></td>
<td><p>18</p></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="peak_models.html" class="btn btn-neutral float-left" title="Peak models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workflow.html" class="btn btn-neutral float-right" title="Workflow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2024, The Fitspy development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>