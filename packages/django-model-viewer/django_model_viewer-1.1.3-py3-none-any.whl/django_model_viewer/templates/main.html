<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Relations Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <div class="container mx-auto py-10">
      <div class="mb-5">
        <div class="grid grid-cols-8 gap-2 w-full max-w-[23rem]">
          <input id="path_input" type="text" class="bg-violet-300 col-span-6 bg-gray-50 border border-gray-300 text-gray-500 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" readonly>
          <button id="copy-btn" onclick="CopyRelationsPath()" class="col-span-2 text-white bg-violet-600 hover:bg-violet-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full py-2.5 text-center items-center inline-flex justify-center">
            <span id="default-message">Create path</span>
            <span id="success-message" class="hidden inline-flex items-center">
              <svg class="w-3 h-3 text-white me-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
              </svg>
              Copied!
            </span>
          </button>  
        </div>
      </div>
      <button data-modal-target="settings-modal" data-modal-toggle="settings-modal" class="absolute top-13 right-5 text-white bg-violet-600 hover:bg-violet-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center" type="button">Settings</button>
      
      <button data-modal-target="default-modal" data-modal-toggle="default-modal" class="absolute top-5 right-5 text-white bg-violet-600 hover:bg-violet-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center" type="button">About</button>
      
      <div class="mb-5 relative">
        <label for="model-select" class="block text-sm font-medium text-gray-700">Select Model:</label>
        <div class="mt-1 relative">
          <button id="dropdownSearchButton" data-dropdown-toggle="dropdownSearch" class="w-full text-left py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
            Select a model
          </button>
          <div id="dropdownSearch" class="hidden z-10 w-full bg-white rounded-md shadow-lg">
            <div class="px-3 py-2">
              <input type="text" id="dropdownSearchInput" class="block w-full py-2 px-3 border border-gray-300 rounded-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Search...">
            </div>
            <ul id="dropdownSearchOptions" class="py-2 text-sm text-gray-700" aria-labelledby="dropdownSearchButton">
            
            </ul>
          </div>
        </div>
      </div>  

      <!-- Main modal -->
      <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-2xl max-h-full">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow">
                <!-- Modal header -->
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                    <h3 class="text-xl text-gray-900 text-center">
                        About <span class="font-semibold underline">Models-Viewer</span>
                    </h3>
                </div>
                <!-- Modal body -->
                <div class="p-4 md:p-5 space-y-4">
                    <p class="text-base leading-relaxed text-gray-700">
                      An application that facilitates identification and operation on models. It searches for all available models in the project and allows you to select and view details about them by holding the mouse on the parameter of interest. After selecting the path between models through relations, after clicking CREATE we will get a path that allows you to get to the last model. It is also possible to select a model and click on its name and it will take you to Visual Studio Code to the file and line of the given model
                    </p>
                    <p class="text-base leading-relaxed text-gray-700">
                      <strong class="text-grey-800">Relations:</strong><br>
                      Green color means normal relation.<br>
                      Orange color means reverse relation.
                    </p>
                </div>
                <!-- Modal footer -->
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b">
                    <button data-modal-hide="default-modal" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Close</button>
                </div>
            </div>
        </div>
      </div>

      <div id="modal-div"></div>

      <!-- Settings modal-->
      <div id="settings-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-2xl max-h-full">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow">
                <!-- Modal header -->
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t text-center">
                    <h3 class="text-xl text-gray-900 text-center">
                        <span class="font-semibold underline">Settings</span>
                    </h3>
                </div>
                <!-- Modal body -->
                <div class="p-4 md:p-2 space-y-4">
                  <table class="w-full text-sm text-middle text-gray-700">
                    <thead class="text-xs uppercase bg-gray-200">
                      <tr>
                        <th class="px-6 py-3">Font color</th>
                        <th class="px-6 py-3">Field type</th>
                        <th class="px-6 py-3">Background color</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Forward Relations -->
                       <tr class="text-center text-2xl text-gray-900 font-semibold"><td></td><td>Forward</td><td></td></tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="OneToOneField" value="#881337" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">OneToOneField</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="OneToOneField" value="#fda4af" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="ForeignKey" value="#f9a8d4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">ForeignKey</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="ForeignKey" value="#831843" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="ManyToManyField" value="#f0abfc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">ManyToManyField</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="ManyToManyField" value="#701a75" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                
                      <!-- Reverse Relations -->
                      <tr class="text-center text-2xl text-gray-900 font-semibold"><td></td><td>Reverse</td><td></td></tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="OneToOneRel" value="#c084fc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">OneToOneRel</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="OneToOneRel" value="#581c87" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="ManyToOneRel" value="#818cf8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">ManyToOneRel</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="ManyToOneRel" value="#1e1b4b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                      <tr>
                        <td><input onchange="set_new_colors(this)" type="color" id="color" name="ManyToManyRel" value="#7dd3fc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                        <td class="text-center">ManyToManyRel</td>
                        <td><input onchange="set_new_colors(this)" type="color" id="background-color" name="ManyToManyRel" value="#075985" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <!-- Modal footer -->
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b">
                    <button data-modal-hide="settings-modal" type="button" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Close</button>
                </div>
            </div>
        </div>
      </div>

      <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-700">
          <thead class="text-xs uppercase bg-gray-200">
            <tr>
              <th class="px-6 py-3">Model Name</th>
              <th class="px-6 py-3">Fields</th>
              <th class="px-6 py-3">Relations</th>
              <th class="px-6 py-3">Functions</th>
            </tr>
          </thead>
          <tbody id="model-table-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  <script>
    $(document).ready(function () {
      let displayedModels = new Set(); 

      let map = new Map();

        //colors from tailwind v3.4.10
        
        //forward
        map.set('OneToOneField', ['#881337', '#fda4af']); //rose 300/900
        map.set('ForeignKey', ['#f9a8d4', '#831843']); //pink 300/900
        map.set('ManyToManyField', ['#f0abfc', '#701a75']); //fuchsia 300/900
        //reverse
        map.set('OneToOneRel', ['#c084fc', '#581c87']); //purple 400/900
        map.set('ManyToOneRel', ['#818cf8', '#1e1b4b']); //indigo 400/950
        map.set('ManyToManyRel', ['#7dd3fc', '#075985']); //sky 300/800

        //clicked field
        map.set('Selected', ['#00ff1f', '#427448'])

        map.set('default', ['#1E429F', '#E1EFFE'])

      let data = JSON.parse("{{ models | escapejs }}");

      $.each(data, function (index, object) {
        $("#dropdownSearchOptions").append(
          `<li><button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-100" data-value="${index}" data-name="${object.name}">${object.name}</button></li>`
        );
      });

      $("#dropdownSearchOptions button").on("click", function () {
        const selectedIndex = $(this).data('value');
        const selectedName = $(this).data('name');
        $("#dropdownSearchButton").text(selectedName);
        $("#dropdownSearch").addClass("hidden");

        const selectedModel = data[selectedIndex];
        $("#model-table-body").empty();  
        displayedModels.clear();         

        if (selectedModel) {
          $.ajax({
            url: '{% url "aqSFrOMAEQgBlduCuYfr" %}',
            data: {
              model: selectedName,
            },
            success: function (response) {
              const modelData = response.data;
              if (modelData) {
                //console.log(modelData);
                appendModelRow(modelData);
                displayedModels.add(modelData.name);
              }
            },
            error: function (xhr, status, error) {
              console.error(`Error fetching data for model ${selectedName}: ${error}`);
            },
          });
        }
      });


      $("#dropdownSearchInput").on("input", function () {
        const searchTerm = $(this).val().toLowerCase();
        $("#dropdownSearchOptions li").each(function () {
          const text = $(this).text().toLowerCase();
          $(this).toggle(text.includes(searchTerm));
        });
      });

      $("#model-select").on("change", function () {
        const selectedIndex = $(this).val();
        const selectedName = $("#model-select option:selected").attr("name");
        const selectedModel = data[selectedIndex];
        $("#model-table-body").empty();  
        displayedModels.clear();         

        if (selectedModel) {
          $.ajax({
            url: '{% url "aqSFrOMAEQgBlduCuYfr" %}',
            data: {
              model: selectedName,
            },
            success: function (response) {
              const modelData = response.data;
              if (modelData) {
              appendModelRow(modelData);
              displayedModels.add(modelData.name);
              }
            },
            error: function (xhr, status, error) {
              console.error(`Error fetching data for model ${selectedName}: ${error}`);
            },
          });
        }
      });

      function appendModelRow(modelData) {
        let fieldsContent = "";
        let relationsContent = "";
        let func_info = "";
        let func_data = JSON.parse(modelData.functions);
        console.log(func_data);

        $.each(modelData.fields, function (fieldType, fieldsArray) {
          if (fieldType !== "OneToOneRel" && fieldType !== "ManyToOneRel" && fieldType !== 'ManyToManyRel' && fieldType !== 'OneToOneField' && fieldType !== 'ForeignKey' && fieldType !== 'ManyToManyField') {
            $.each(fieldsArray, function (index, field) {
              const field_data = field.data.replace(/\"/g, "'")
              fieldsContent += `<span style="color:${map.get('default')[0]}; background-color:${map.get('default')[1]};" name='default' class="inline-block text-xs font-semibold mr-2 px-2.5 py-0.5 rounded" title="${field_data}">${field.name}</span>`;
            });
          }
        });

        $.each(modelData.relations, function (relationType, relationsArray) {
          $.each(relationsArray, function (index, relation) {

            let element_values = map.get(relation.relation_type)

            const relation_data = relation.data.replace(/\"/g, "'");
            relationsContent += `<button name="${relation.relation_type}" style="color:${element_values[0]}; background-color:${element_values[1]}" class="inline-block text-xs font-semibold mr-2 px-2.5 py-0.5 rounded hover:underline" title="${relation_data}" onclick="fetchRelatedModel('${relation.related_model}', this)">${relation.field_name}</button>`;
          });
        });

        $.each(func_data, function(index, data){
          let repaired_data = data.data.replace(/\n/g, '<br>');
          func_info+= `<button data-modal-target="${modelData.name}-${data.name}-modal" data-modal-toggle="${modelData.name}-${data.name}-modal" type="button" class="text-gray-900 border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 inline-block text-xs font-semibold mr-2 px-2.5 py-0.5 rounded hover:underline">${data.name}</button>`
          
          $('#modal-div').append(`
          <div id="${modelData.name}-${data.name}-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
            <div class="relative p-4 w-full max-w-2xl max-h-full">
                <div class="relative bg-white rounded-lg">
                    <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                        <h3 class="text-xl font-semibold text-gray-900">
                            ${data.name}
                        </h3>
                    </div>
                    <div class="p-4 md:p-5 space-y-4">
                        <p class="text-base leading-relaxed text-gray-500">
                           ${repaired_data}
                        </p>
                    </div>
                    <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b">
                        <button data-modal-hide="${modelData.name}-${data.name}-modal" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">I accept</button>
                        <button data-modal-hide="${modelData.name}-${data.name}-modal" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100">Decline</button>
                    </div>
                </div>
            </div>
          </div>
          `);
        
        });
        $("#model-table-body").append(`
          <tr id="${modelData.name}">
            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap hover:bg-gray-300 cursor-pointer" onclick="window.location.href='${modelData.url}'">
              ${modelData.name}
            </td>
            <td class="px-6 py-4">${fieldsContent || "N/A"}</td>
            <td class="px-6 py-4">${relationsContent || "N/A"}</td>
            <td class="px-6 py-4">${func_info || "N/A"}</td>
          </tr>
        `);
      }

      window.fetchRelatedModel = function (modelName, btnElement) {

      $(btnElement).closest('td').find('button').each(function() {
        let el_val = map.get($(this).attr('name'))

        $(this).css('color', el_val[1]).css('background-color', el_val[0]);
        });

        
        $(btnElement).css('color', '#00ff1f').css('background-color', '#427448');

        let currentRow = $(btnElement).closest("tr");
        currentRow.nextAll("tr").remove();

        $.ajax({
          url: '{% url "aqSFrOMAEQgBlduCuYfr" %}',
          data: {
            model: modelName,
          },
          success: function (response) {
            const modelData = response.data;
            if (modelData) {
              appendModelRow(modelData);
              displayedModels.add(modelData.name);
            }
          },
          error: function (xhr, status, error) {
            console.error(`Error fetching data for model ${modelName}: ${error}`);
          },
        });
      };

      window.CopyRelationsPath = function(){
        const list_of_elemenets = [];
        elements = $('#model-table-body').children();
        $.each(elements, function(index, element){
          list_of_elemenets.push(element.id)
        });

        $.ajax({
          url: '{% url "AZVTNbMJfPHKWIorjAIz" %}',
          data: {
            list: JSON.stringify(list_of_elemenets),
          },
          success: function (response) {
            $('#path_input').val(response.path);
            navigator.clipboard.writeText(response.path);
            showSuccessMessage();
          },
          error: function (xhr, status, error) {
            console.error(`Error finding relation for model ${list_of_elemenets}`);
          },
        });
      };

      window.new_colors_for_buttons = function(element) {
        let elements_name = $(element).attr('name');
        let type = $(element).attr('id') === "color" ? 0 : 1;
        let value = map.get(elements_name)[type];
    
        let buttons = $(`button[name^="${elements_name}"]`);
        //console.log('FOUND BUTTONS', buttons);
        
        buttons.each(function() {
            console.log('Current button:', this);
            if (type === 0) {
                //console.log('Setting color to:', value);
                this.style.color = value; 
                $(this).css('color', `${value}`)
            } else {
                //console.log('Setting background-color to:', value);
                this.style.backgroundColor = value; 
                $(this).css('background-color', `${value}`)
            }
        });
    };
    
      function showSuccessMessage() {
        $("#default-message").addClass("hidden");
        $("#success-message").removeClass("hidden");
        setTimeout(() => {
          $("#default-message").removeClass("hidden");
          $("#success-message").addClass("hidden");
        }, 2000);
      }

  
    });
    function set_new_colors(element){
      window.new_colors_for_buttons(element);
    }

    // Delegacja zdarzeń do dynamicznych przycisków
    $(document).on('click', '[data-modal-toggle]', function() {
      var modalId = $(this).attr('data-modal-toggle');
      $('#' + modalId).removeClass('hidden');
  });

  // Delegacja zdarzeń do zamknięcia modala
  $(document).on('click', '[data-modal-hide]', function() {
      var modalId = $(this).attr('data-modal-hide');
      $('#' + modalId).addClass('hidden');
  });
  </script>
  </body>
</html>